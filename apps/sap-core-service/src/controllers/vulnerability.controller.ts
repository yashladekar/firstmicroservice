import { Request, Response } from "express";
import prisma from "../config/db";

export async function getSystemVulnerabilities(
    req: Request,
    res: Response
) {
    const { sid } = req.params;

    // 1️⃣ Find system
    const system = await prisma.system.findUnique({
        where: { sid },
    });

    if (!system) {
        return res.status(404).json({ message: "System not found" });
    }

    // 2️⃣ Fetch vulnerabilities
    const vulnerabilities = await prisma.sapVulnerability.findMany({
        where: { systemId: system.sid },
        include: {
            note: {
                select: {
                    noteNumber: true,
                    priority: true,
                    cvssScore: true,
                    cvssVector: true,
                },
            },
        },
    });

    // 3️⃣ Shape response
    const response = vulnerabilities.map((v: (typeof vulnerabilities)[number]) => ({
        component: v.componentName,
        installedVersion: v.componentVersion,
        noteNumber: v.noteNumber,
        priority: v.note?.priority,
        cvssScore: v.note?.cvssScore,
        affectedRange: {
            from: v.fromVersion,
            to: v.toVersion,
        },
    }));

    res.json({
        system: sid,
        totalVulnerabilities: response.length,
        vulnerabilities: response,
    });
}
