// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ---------------------------------------------------------
// Imported/shared models (used by vulnerability matcher)
// These correspond to tables populated by other services.
// ---------------------------------------------------------

model System {
  sid String @id @unique

  mainProduct String?
  dbVersion   String?
  osType      String?

  osVersion      String?
  osPatch        String?
  kernelRelease  String?
  dbslVersion    String?
  dbslPatchLevel String?

  vmJavaVersion     String?
  vmRuntimeVersion  String?
  javaKernelVersion String?

  abapComponents AbapComponent[]
  javaComponents JavaComponent[]

  vulnerabilities SapVulnerability[]

  updatedAt DateTime @updatedAt
}

model AbapComponent {
  id String @id @default(uuid())

  component        String
  release          String
  spLevel          String?
  supportPackage   String?
  shortDescription String?

  systemSid String
  system    System @relation(fields: [systemSid], references: [sid], onDelete: Cascade)

  @@index([systemSid])
}

model JavaComponent {
  id String @id @default(uuid())

  name     String
  vendor   String?
  version  String
  location String?

  systemSid String
  system    System @relation(fields: [systemSid], references: [sid], onDelete: Cascade)

  @@index([systemSid])
}

model SapNote {
  id         String   @id @default(uuid())

  noteNumber String   @unique
  priority   String?
  cvssScore  Float?
  cvssVector String?

  confidence Int
  correction String?

  rawText    String
  createdAt  DateTime @default(now())

  components SapNoteComponent[]

  vulnerabilities SapVulnerability[]
}

model SapNoteComponent {
  id          String  @id @default(uuid())

  noteId      String
  note        SapNote @relation(fields: [noteId], references: [id], onDelete: Cascade)

  component   String
  fromVersion String?
  toVersion   String?
  fixedInSp  String?
  @@unique([noteId, component])
}

model SapVulnerability {
  id            String   @id @default(uuid())

  systemId      String
  system        System   @relation(fields: [systemId], references: [sid], onDelete: Cascade)
  componentName String
  componentVersion String

  noteId        String
  note          SapNote  @relation(fields: [noteId], references: [id], onDelete: Cascade)
  noteNumber    String

  fromVersion   String?
  toVersion     String?

  detectedAt    DateTime @default(now())

  @@unique([systemId, componentName, noteId])
  @@index([systemId])
  @@index([noteId])
}
